{"dependencies":[{"name":"react","loc":{"line":9,"column":18}},{"name":"prop-types","loc":{"line":10,"column":22}},{"name":"draft-js","loc":{"line":11,"column":146}},{"name":"immutable","loc":{"line":12,"column":26}},{"name":"setimmediate","loc":{"line":13,"column":7}},{"name":"../Toolbar","loc":{"line":14,"column":30}},{"name":"./ConfigStore","loc":{"line":15,"column":24}},{"name":"./export/getHTML","loc":{"line":16,"column":20}},{"name":"./export/exportText","loc":{"line":17,"column":42}},{"name":"./customHTML2Content","loc":{"line":18,"column":31}}],"generated":{"js":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar _react = require(\"react\");\n\nvar _react2 = _interopRequireDefault(_react);\n\nvar _propTypes = require(\"prop-types\");\n\nvar _propTypes2 = _interopRequireDefault(_propTypes);\n\nvar _draftJs = require(\"draft-js\");\n\nvar _immutable = require(\"immutable\");\n\nrequire(\"setimmediate\");\n\nvar _Toolbar = require(\"../Toolbar\");\n\nvar _ConfigStore = require(\"./ConfigStore\");\n\nvar _ConfigStore2 = _interopRequireDefault(_ConfigStore);\n\nvar _getHTML = require(\"./export/getHTML\");\n\nvar _getHTML2 = _interopRequireDefault(_getHTML);\n\nvar _exportText = require(\"./export/exportText\");\n\nvar _exportText2 = _interopRequireDefault(_exportText);\n\nvar _customHTML2Content = require(\"./customHTML2Content\");\n\nvar _customHTML2Content2 = _interopRequireDefault(_customHTML2Content);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar _extends = Object.assign || function (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];for (var key in source) {\n      if (Object.prototype.hasOwnProperty.call(source, key)) {\n        target[key] = source[key];\n      }\n    }\n  }return target;\n};\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }return call && ((typeof call === \"undefined\" ? \"undefined\" : _typeof(call)) === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + (typeof superClass === \"undefined\" ? \"undefined\" : _typeof(superClass)));\n  }subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } });if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nvar hasCommandModifier = _draftJs.KeyBindingUtil.hasCommandModifier;\n\nfunction noop() {}\n;\nvar defaultPluginConfig = {};\nvar focusDummyStyle = {\n  width: 0,\n  opacity: 0,\n  border: 0,\n  position: 'absolute',\n  left: 0,\n  top: 0\n};\nvar toolbar = (0, _Toolbar.createToolbar)();\nvar configStore = new _ConfigStore2.default();\n\nvar EditorCore = function (_React$Component) {\n  _inherits(EditorCore, _React$Component);\n\n  function EditorCore(props) {\n    _classCallCheck(this, EditorCore);\n\n    var _this = _possibleConstructorReturn(this, _React$Component.call(this, props));\n\n    _this.cancelForceUpdateImmediate = function () {\n      clearImmediate(_this.forceUpdateImmediate);\n      _this.forceUpdateImmediate = null;\n    };\n    _this.handlePastedText = function (text, html) {\n      var editorState = _this.state.editorState;\n\n      if (html) {\n        var contentState = editorState.getCurrentContent();\n        var selection = editorState.getSelection();\n        var fragment = (0, _customHTML2Content2.default)(html, contentState);\n        var pastedContent = _draftJs.Modifier.replaceWithFragment(contentState, selection, fragment);\n        var newContent = pastedContent.merge({\n          selectionBefore: selection,\n          selectionAfter: pastedContent.getSelectionAfter().set('hasFocus', true)\n        });\n        _this.setEditorState(_draftJs.EditorState.push(editorState, newContent, 'insert-fragment'), true);\n        return 'handled';\n      }\n      return 'not-handled';\n    };\n    _this.plugins = (0, _immutable.List)((0, _immutable.List)(props.plugins).flatten(true));\n    var editorState = void 0;\n    if (props.value !== undefined) {\n      if (props.value instanceof _draftJs.EditorState) {\n        editorState = props.value || _draftJs.EditorState.createEmpty();\n      } else {\n        editorState = _draftJs.EditorState.createEmpty();\n      }\n    } else {\n      editorState = _draftJs.EditorState.createEmpty();\n    }\n    editorState = _this.generatorDefaultValue(editorState);\n    _this.state = {\n      plugins: _this.reloadPlugins(),\n      editorState: editorState,\n      customStyleMap: {},\n      customBlockStyleMap: {},\n      compositeDecorator: null\n    };\n    if (props.value !== undefined) {\n      _this.controlledMode = true;\n      console.warn('this component is in controllred mode');\n    }\n    return _this;\n  }\n\n  EditorCore.ToEditorState = function ToEditorState(text) {\n    var createEmptyContentState = _draftJs.ContentState.createFromText((0, _exportText.decodeContent)(text) || '');\n    var editorState = _draftJs.EditorState.createWithContent(createEmptyContentState);\n    return _draftJs.EditorState.forceSelection(editorState, createEmptyContentState.getSelectionAfter());\n  };\n\n  EditorCore.prototype.Reset = function Reset() {\n    var defaultValue = this.props.defaultValue;\n\n    var contentState = defaultValue ? defaultValue.getCurrentContent() : _draftJs.ContentState.createFromText('');\n    var updatedEditorState = _draftJs.EditorState.push(this.state.editorState, contentState, 'remove-range');\n    this.setEditorState(_draftJs.EditorState.forceSelection(updatedEditorState, contentState.getSelectionBefore()));\n  };\n\n  EditorCore.prototype.SetText = function SetText(text) {\n    var createTextContentState = _draftJs.ContentState.createFromText(text || '');\n    var editorState = _draftJs.EditorState.push(this.state.editorState, createTextContentState, 'change-block-data');\n    this.setEditorState(_draftJs.EditorState.moveFocusToEnd(editorState), true);\n  };\n\n  EditorCore.prototype.getChildContext = function getChildContext() {\n    return {\n      getEditorState: this.getEditorState,\n      setEditorState: this.setEditorState\n    };\n  };\n\n  EditorCore.prototype.reloadPlugins = function reloadPlugins() {\n    var _this2 = this;\n\n    return this.plugins && this.plugins.size ? this.plugins.map(function (plugin) {\n      //　如果插件有 callbacks 方法,则认为插件已经加载。\n      if (plugin.callbacks) {\n        return plugin;\n      }\n      // 如果插件有 constructor 方法,则构造插件\n      if (plugin.hasOwnProperty('constructor')) {\n        var pluginConfig = _extends(_this2.props.pluginConfig, plugin.config || {}, defaultPluginConfig);\n        return plugin.constructor(pluginConfig);\n      }\n      // else 无效插件\n      console.warn('>> 插件: [', plugin.name, '] 无效。插件或许已经过期。');\n      return false;\n    }).filter(function (plugin) {\n      return plugin;\n    }).toArray() : [];\n  };\n\n  EditorCore.prototype.componentWillMount = function componentWillMount() {\n    var plugins = this.initPlugins().concat([toolbar]);\n    var customStyleMap = {};\n    var customBlockStyleMap = {};\n    var customBlockRenderMap = (0, _immutable.Map)(_draftJs.DefaultDraftBlockRenderMap);\n    var toHTMLList = (0, _immutable.List)([]);\n    // initialize compositeDecorator\n    var compositeDecorator = new _draftJs.CompositeDecorator(plugins.filter(function (plugin) {\n      return plugin.decorators !== undefined;\n    }).map(function (plugin) {\n      return plugin.decorators;\n    }).reduce(function (prev, curr) {\n      return prev.concat(curr);\n    }, []));\n    // initialize Toolbar\n    var toolbarPlugins = (0, _immutable.List)(plugins.filter(function (plugin) {\n      return !!plugin.component && plugin.name !== 'toolbar';\n    }));\n    // load inline styles...\n    plugins.forEach(function (plugin) {\n      var styleMap = plugin.styleMap,\n          blockStyleMap = plugin.blockStyleMap,\n          blockRenderMap = plugin.blockRenderMap,\n          toHtml = plugin.toHtml;\n\n      if (styleMap) {\n        for (var key in styleMap) {\n          if (styleMap.hasOwnProperty(key)) {\n            customStyleMap[key] = styleMap[key];\n          }\n        }\n      }\n      if (blockStyleMap) {\n        for (var _key in blockStyleMap) {\n          if (blockStyleMap.hasOwnProperty(_key)) {\n            customBlockStyleMap[_key] = blockStyleMap[_key];\n            customBlockRenderMap = customBlockRenderMap.set(_key, {\n              element: null\n            });\n          }\n        }\n      }\n      if (toHtml) {\n        toHTMLList = toHTMLList.push(toHtml);\n      }\n      if (blockRenderMap) {\n        for (var _key2 in blockRenderMap) {\n          if (blockRenderMap.hasOwnProperty(_key2)) {\n            customBlockRenderMap = customBlockRenderMap.set(_key2, blockRenderMap[_key2]);\n          }\n        }\n      }\n    });\n    configStore.set('customStyleMap', customStyleMap);\n    configStore.set('customBlockStyleMap', customBlockStyleMap);\n    configStore.set('blockRenderMap', customBlockRenderMap);\n    configStore.set('customStyleFn', this.customStyleFn.bind(this));\n    configStore.set('toHTMLList', toHTMLList);\n    this.setState({\n      toolbarPlugins: toolbarPlugins,\n      compositeDecorator: compositeDecorator\n    });\n    this.setEditorState(_draftJs.EditorState.set(this.state.editorState, { decorator: compositeDecorator }));\n  };\n\n  EditorCore.prototype.componentWillReceiveProps = function componentWillReceiveProps(nextProps) {\n    if (this.forceUpdateImmediate) {\n      this.cancelForceUpdateImmediate();\n    }\n    if (this.controlledMode) {\n      var decorators = nextProps.value.getDecorator();\n      var editorState = decorators ? nextProps.value : _draftJs.EditorState.set(nextProps.value, { decorator: this.state.compositeDecorator });\n      this.setState({\n        editorState: editorState\n      });\n    }\n  };\n\n  EditorCore.prototype.componentWillUnmount = function componentWillUnmount() {\n    this.cancelForceUpdateImmediate();\n  };\n  //  处理　value　\n\n\n  EditorCore.prototype.generatorDefaultValue = function generatorDefaultValue(editorState) {\n    var defaultValue = this.props.defaultValue;\n\n    if (defaultValue) {\n      return defaultValue;\n    }\n    return editorState;\n  };\n\n  EditorCore.prototype.getStyleMap = function getStyleMap() {\n    return configStore.get('customStyleMap');\n  };\n\n  EditorCore.prototype.setStyleMap = function setStyleMap(customStyleMap) {\n    configStore.set('customStyleMap', customStyleMap);\n    this.render();\n  };\n\n  EditorCore.prototype.initPlugins = function initPlugins() {\n    var _this3 = this;\n\n    var enableCallbacks = ['focus', 'getEditorState', 'setEditorState', 'getStyleMap', 'setStyleMap'];\n    return this.getPlugins().map(function (plugin) {\n      enableCallbacks.forEach(function (callbackName) {\n        if (plugin.callbacks.hasOwnProperty(callbackName)) {\n          plugin.callbacks[callbackName] = _this3[callbackName].bind(_this3);\n        }\n      });\n      return plugin;\n    });\n  };\n\n  EditorCore.prototype.focusEditor = function focusEditor(ev) {\n    this.refs.editor.focus(ev);\n    if (this.props.readOnly) {\n      this._focusDummy.focus();\n    }\n    if (this.props.onFocus) {\n      this.props.onFocus(ev);\n    }\n  };\n\n  EditorCore.prototype.focus = function focus(ev) {\n    var _this4 = this;\n\n    if (!ev || !ev.nativeEvent || !ev.nativeEvent.target) {\n      return;\n    }\n    var event = ev.nativeEvent;\n    if (document.activeElement && document.activeElement.getAttribute('contenteditable') === 'true') {\n      return;\n    }\n    if (event.target === this._editorWrapper) {\n      var editorState = this.state.editorState;\n\n      var selection = editorState.getSelection();\n      if (!selection.getHasFocus()) {\n        if (selection.isCollapsed()) {\n          return this.setState({\n            editorState: _draftJs.EditorState.moveFocusToEnd(editorState)\n          }, function () {\n            _this4.focusEditor(ev);\n          });\n        }\n      }\n    }\n    this.focusEditor(ev);\n  };\n\n  EditorCore.prototype.getPlugins = function getPlugins() {\n    return this.state.plugins.slice();\n  };\n\n  EditorCore.prototype.getEventHandler = function getEventHandler() {\n    var _this5 = this;\n\n    var enabledEvents = ['onUpArrow', 'onDownArrow', 'handleReturn', 'onFocus', 'onBlur', 'onTab', 'handlePastedText'];\n    var eventHandler = {};\n    enabledEvents.forEach(function (event) {\n      eventHandler[event] = _this5.generatorEventHandler(event);\n    });\n    return eventHandler;\n  };\n\n  EditorCore.prototype.getEditorState = function getEditorState() {\n    var needFocus = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n\n    if (needFocus) {\n      this.refs.editor.focus();\n    }\n    return this.state.editorState;\n  };\n\n  EditorCore.prototype.setEditorState = function setEditorState(editorState) {\n    var _this6 = this;\n\n    var focusEditor = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    var newEditorState = editorState;\n    this.getPlugins().forEach(function (plugin) {\n      if (plugin.onChange) {\n        var updatedEditorState = plugin.onChange(newEditorState);\n        if (updatedEditorState) {\n          newEditorState = updatedEditorState;\n        }\n      }\n    });\n    if (this.props.onChange) {\n      this.props.onChange(newEditorState);\n      // close this issue https://github.com/ant-design/ant-design/issues/5788\n      // when onChange not take any effect\n      // `<Editor />` won't rerender cause no props is changed.\n      // add an timeout here,\n      // if props.onChange not trigger componentWillReceiveProps,\n      // we will force render Editor with previous editorState,\n      if (this.controlledMode) {\n        this.forceUpdateImmediate = setImmediate(function () {\n          return _this6.setState({\n            editorState: new _draftJs.EditorState(_this6.state.editorState.getImmutable())\n          });\n        });\n      }\n    }\n    if (!this.controlledMode) {\n      this.setState({ editorState: newEditorState }, focusEditor ? function () {\n        return setImmediate(function () {\n          return _this6.refs.editor.focus();\n        });\n      } : noop);\n    }\n  };\n\n  EditorCore.prototype.handleKeyBinding = function handleKeyBinding(ev) {\n    if (this.props.onKeyDown) {\n      ev.ctrlKey = hasCommandModifier(ev);\n      var keyDownResult = this.props.onKeyDown(ev);\n      if (keyDownResult) {\n        return keyDownResult;\n      }\n      return (0, _draftJs.getDefaultKeyBinding)(ev);\n    }\n    return (0, _draftJs.getDefaultKeyBinding)(ev);\n  };\n\n  EditorCore.prototype.handleKeyCommand = function handleKeyCommand(command) {\n    if (this.props.multiLines) {\n      return this.eventHandle('handleKeyBinding', command);\n    }\n    return command === 'split-block' ? 'handled' : 'not-handled';\n  };\n\n  EditorCore.prototype.getBlockStyle = function getBlockStyle(contentBlock) {\n    var customBlockStyleMap = configStore.get('customBlockStyleMap');\n    var type = contentBlock.getType();\n    if (customBlockStyleMap.hasOwnProperty(type)) {\n      return customBlockStyleMap[type];\n    }\n  };\n\n  EditorCore.prototype.blockRendererFn = function blockRendererFn(contentBlock) {\n    var blockRenderResult = null;\n    this.getPlugins().forEach(function (plugin) {\n      if (plugin.blockRendererFn) {\n        var result = plugin.blockRendererFn(contentBlock);\n        if (result) {\n          blockRenderResult = result;\n        }\n      }\n    });\n    return blockRenderResult;\n  };\n\n  EditorCore.prototype.eventHandle = function eventHandle(eventName) {\n    var _props;\n\n    var plugins = this.getPlugins();\n\n    for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key3 = 1; _key3 < _len; _key3++) {\n      args[_key3 - 1] = arguments[_key3];\n    }\n\n    for (var i = 0; i < plugins.length; i++) {\n      var plugin = plugins[i];\n      if (plugin.callbacks[eventName] && typeof plugin.callbacks[eventName] === 'function') {\n        var _plugin$callbacks;\n\n        var result = (_plugin$callbacks = plugin.callbacks)[eventName].apply(_plugin$callbacks, args);\n        if (result === true) {\n          return 'handled';\n        }\n      }\n    }\n    return this.props.hasOwnProperty(eventName) && (_props = this.props)[eventName].apply(_props, args) === true ? 'handled' : 'not-handled';\n  };\n\n  EditorCore.prototype.generatorEventHandler = function generatorEventHandler(eventName) {\n    var _this7 = this;\n\n    return function () {\n      for (var _len2 = arguments.length, args = Array(_len2), _key4 = 0; _key4 < _len2; _key4++) {\n        args[_key4] = arguments[_key4];\n      }\n\n      return _this7.eventHandle.apply(_this7, [eventName].concat(args));\n    };\n  };\n\n  EditorCore.prototype.customStyleFn = function customStyleFn(styleSet) {\n    if (styleSet.size === 0) {\n      return {};\n    }\n    var plugins = this.getPlugins();\n    var resultStyle = {};\n    for (var i = 0; i < plugins.length; i++) {\n      if (plugins[i].customStyleFn) {\n        var styled = plugins[i].customStyleFn(styleSet);\n        if (styled) {\n          _extends(resultStyle, styled);\n        }\n      }\n    }\n    return resultStyle;\n  };\n\n  EditorCore.prototype.render = function render() {\n    var _this8 = this;\n\n    var _props2 = this.props,\n        prefixCls = _props2.prefixCls,\n        toolbars = _props2.toolbars,\n        style = _props2.style,\n        readOnly = _props2.readOnly;\n    var _state = this.state,\n        editorState = _state.editorState,\n        toolbarPlugins = _state.toolbarPlugins;\n\n    var customStyleMap = configStore.get('customStyleMap');\n    var blockRenderMap = configStore.get('blockRenderMap');\n    var eventHandler = this.getEventHandler();\n    var Toolbar = toolbar.component;\n    return _react2.default.createElement('div', { style: style, className: prefixCls + '-editor ' + (readOnly ? 'readonly' : ''), onClick: this.focus.bind(this) }, _react2.default.createElement(Toolbar, { editorState: editorState, prefixCls: prefixCls, className: prefixCls + '-toolbar', plugins: toolbarPlugins, toolbars: toolbars }), _react2.default.createElement('div', { className: prefixCls + '-editor-wrapper', ref: function ref(ele) {\n        return _this8._editorWrapper = ele;\n      }, style: style, onClick: function onClick(ev) {\n        return ev.preventDefault();\n      } }, _react2.default.createElement(_draftJs.Editor, _extends({}, this.props, eventHandler, { ref: 'editor', customStyleMap: customStyleMap, customStyleFn: this.customStyleFn.bind(this), editorState: editorState, handleKeyCommand: this.handleKeyCommand.bind(this), keyBindingFn: this.handleKeyBinding.bind(this), onChange: this.setEditorState.bind(this), blockStyleFn: this.getBlockStyle.bind(this), blockRenderMap: blockRenderMap, handlePastedText: this.handlePastedText, blockRendererFn: this.blockRendererFn.bind(this) })), readOnly ? _react2.default.createElement('input', { style: focusDummyStyle, ref: function ref(ele) {\n        return _this8._focusDummy = ele;\n      }, onBlur: eventHandler.onBlur }) : null, this.props.children));\n  };\n\n  return EditorCore;\n}(_react2.default.Component);\n\nEditorCore.GetText = _exportText2.default;\nEditorCore.GetHTML = (0, _getHTML2.default)(configStore);\nEditorCore.defaultProps = {\n  multiLines: true,\n  plugins: [],\n  prefixCls: 'rc-editor-core',\n  pluginConfig: {},\n  toolbars: [],\n  spilitLine: 'enter'\n};\nEditorCore.childContextTypes = {\n  getEditorState: _propTypes2.default.func,\n  setEditorState: _propTypes2.default.func\n};\nexports.default = EditorCore;"},"hash":"e83944bf8014d310eefc960e40ccf5ba"}